<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PetAlerta</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        html, body { height: 100%; margin: 0; padding: 0; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        #app-container { display: flex; flex-direction: column; min-height: 100vh; }
        #main-content { flex-grow: 1; overflow-y: auto; position: relative; }
        .leaflet-container { height: 100%; width: 100%; }
        .tab { transition: all 0.2s ease-in-out; }
        .tab-active { color: #f97316; border-bottom-color: #f97316; }
        .loader { border-top-color: #f97316; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .map-filter-btn.active-filter { background-color: #f97316; color: white; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üêæ</text></svg>">
</head>
<body class="bg-gray-100">

    <!-- ...restante do HTML igual... -->

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, updateDoc, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        document.addEventListener('DOMContentLoaded', () => {
            // ...vari√°veis, fun√ß√µes e setupApp...

            function setupReportForm(user, petToEdit = null) {
                const reportMapContainer = document.getElementById('report-map');
                let reportMap, marker, currentCoords;
                const title = document.getElementById('report-title'), nameInput = document.getElementById('report-name'), typeInput = document.getElementById('report-type'), contactNameInput = document.getElementById('report-contact-name'), contactPhoneInput = document.getElementById('report-contact-phone'), photoInput = document.getElementById('report-photo'), photoLabel = document.getElementById('photo-label-text'), submitBtn = document.getElementById('report-submit-btn');
                
                const initializeMap = (lat, lng) => {
                    if (reportMap) reportMap.remove();
                    reportMapContainer.innerHTML = '';
                    reportMap = L.map(reportMapContainer).setView([lat, lng], 13);

                    // CORRIGIDO: Adiciona tileLayer e marcador ao objeto correto (reportMap)
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(reportMap);
                    marker = L.marker([lat, lng], { draggable: true }).addTo(reportMap);

                    currentCoords = marker.getLatLng();
                    marker.on('dragend', (e) => { currentCoords = e.target.getLatLng(); });
                };

                if (petToEdit) {
                    title.textContent = 'Editar Alerta'; nameInput.value = petToEdit.name; typeInput.value = petToEdit.type;
                    contactNameInput.value = petToEdit.contactName; contactPhoneInput.value = petToEdit.contactPhone;
                    photoLabel.textContent = 'deixe em branco para n√£o alterar'; submitBtn.innerHTML = 'Guardar Altera√ß√µes';
                    initializeMap(petToEdit.location.latitude, petToEdit.location.longitude);
                } else {
                    title.textContent = 'Reportar Animal Perdido'; nameInput.value = ''; typeInput.value = 'Cachorro';
                    contactNameInput.value = currentUser?.displayName || currentUser?.email?.split('@')[0] || '';
                    contactPhoneInput.value = ''; photoLabel.textContent = 'obrigat√≥ria'; submitBtn.innerHTML = 'Enviar Alerta';
                    navigator.geolocation.getCurrentPosition(pos => initializeMap(pos.coords.latitude, pos.coords.longitude), () => initializeMap(-16.722, -43.869));
                }
                submitBtn.dataset.originalText = submitBtn.innerHTML;
                if (!submitBtn.hasAttribute('data-listener-added')) {
                    submitBtn.addEventListener('click', async () => {
                        if (!marker) { alert("Mapa n√£o foi inicializado. Por favor, aguarde."); return; }
                        const name = nameInput.value, type = typeInput.value, contactName = contactNameInput.value, contactPhone = contactPhoneInput.value, photoFile = photoInput.files[0];
                        if (!name || !contactName || !contactPhone || (!photoFile && !petToEdit)) { alert('Por favor, preencha todos os campos obrigat√≥rios.'); return; }
                        setButtonLoading(submitBtn, true);
                        try {
                            const location = marker.getLatLng();
                            const dataToSave = { name, type, contactName, contactPhone, location: { latitude: location.lat, longitude: location.lng } };
                            if (petToEdit) {
                                let photoUrl = petToEdit.photoUri;
                                if (photoFile) {
                                    const oldImageRef = ref(storage, petToEdit.photoUri);
                                    try { await deleteObject(oldImageRef); } catch (e) { console.warn("Foto antiga n√£o encontrada para apagar, continuando."); }
                                    const newImageRef = ref(storage, `pets/${Date.now()}_${photoFile.name}`);
                                    await uploadBytes(newImageRef, photoFile);
                                    photoUrl = await getDownloadURL(newImageRef);
                                }
                                const petDocRef = doc(db, "pets", petToEdit.id);
                                await updateDoc(petDocRef, { ...dataToSave, photoUri: photoUrl });
                                alert('Alerta atualizado com sucesso!');
                            } else {
                                const storageRef = ref(storage, `pets/${Date.now()}_${photoFile.name}`);
                                await uploadBytes(storageRef, photoFile);
                                const photoUri = await getDownloadURL(storageRef);
                                await addDoc(collection(db, "pets"), { ...dataToSave, photoUri, isFound: false, authorId: user.uid, createdAt: serverTimestamp() });
                                alert('Alerta enviado com sucesso!');
                            }
                            document.querySelector('[data-tab="alerts"]').click();
                        } catch (e) { alert('Erro ao guardar o alerta. Tente novamente.'); console.error("Erro completo:", e);
                        } finally { setButtonLoading(submitBtn, false); }
                    });
                    submitBtn.setAttribute('data-listener-added', 'true');
                }
            }

            // ...restante do JS igual...
        });
    </script>
</body>
</html>
