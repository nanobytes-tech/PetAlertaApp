<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PetAlerta</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        html, body { height: 100%; margin: 0; padding: 0; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        #app-container { display: flex; flex-direction: column; height: 100vh; }
        #main-content { flex-grow: 1; overflow-y: auto; position: relative; }
        .leaflet-container { height: 100%; width: 100%; }
        .tab { transition: all 0.2s ease-in-out; }
        .tab-active { color: #f97316; border-bottom-color: #f97316; }
        .loader { border-top-color: #f97316; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .map-filter-btn.active-filter { background-color: #f97316; color: white; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100">

    <div id="app-container" class="max-w-md mx-auto bg-white shadow-lg h-full">
        <!-- ECRÃS DE INICIALIZAÇÃO -->
        <div id="config-screen" class="p-8 flex flex-col justify-center items-center h-full">
            <h1 class="text-2xl font-bold text-orange-500 mb-4">Configuração Inicial</h1>
            <p class="text-gray-600 mb-6 text-center">Por favor, cole o objeto de configuração do seu projeto Firebase abaixo. Isto só é necessário uma vez.</p>
            <textarea id="firebase-config-input" class="w-full h-48 p-3 border rounded-lg font-mono text-sm" placeholder="{&#10;  apiKey: ...&#10;}"></textarea>
            <button id="save-config-btn" class="mt-6 w-full bg-orange-500 text-white font-bold py-3 rounded-lg hover:bg-orange-600 transition">Guardar e Iniciar</button>
            <p id="config-error" class="mt-4 text-red-500 font-medium"></p>
        </div>
        <div id="loading-screen" class="hidden p-8 flex flex-col justify-center items-center h-full">
            <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24 mb-4"></div>
            <p class="text-lg text-gray-600">A carregar...</p>
        </div>

        <!-- ECRÃS DE AUTENTICAÇÃO -->
        <div id="login-screen" class="hidden p-8 flex flex-col justify-center h-full">
            <h1 class="text-3xl font-bold text-center mb-8">PetAlerta</h1>
            <input id="login-email" type="email" placeholder="Email" class="w-full p-3 mb-4 border rounded-lg">
            <input id="login-password" type="password" placeholder="Palavra-passe" class="w-full p-3 mb-4 border rounded-lg">
            <button id="login-btn" class="w-full bg-orange-500 text-white font-bold py-3 rounded-lg hover:bg-orange-600 transition h-14 flex items-center justify-center"></button>
            <button id="goto-register-btn" class="mt-4 text-orange-500">Não tem conta? Registe-se</button>
        </div>
        <div id="register-screen" class="hidden p-8 flex flex-col justify-center h-full">
            <h1 class="text-3xl font-bold text-center mb-8">Criar Conta</h1>
            <input id="register-email" type="email" placeholder="Email" class="w-full p-3 mb-4 border rounded-lg">
            <input id="register-password" type="password" placeholder="Palavra-passe" class="w-full p-3 mb-4 border rounded-lg">
            <button id="register-btn" class="w-full bg-orange-500 text-white font-bold py-3 rounded-lg hover:bg-orange-600 transition h-14 flex items-center justify-center"></button>
            <button id="goto-login-btn" class="mt-4 text-orange-500">Já tem conta? Entre</button>
        </div>

        <!-- CONTEÚDO PRINCIPAL DA APP -->
        <div id="main-app" class="hidden flex flex-col h-full">
            <header class="p-4 bg-orange-500 text-white flex justify-between items-center shadow-md">
                <h1 class="text-xl font-bold">PetAlerta</h1>
                <button id="logout-btn" class="font-semibold">Sair</button>
            </header>
            <main id="main-content" class="flex-grow bg-gray-50"></main>
            <nav class="grid grid-cols-3 border-t bg-white">
                <button data-tab="map" class="tab tab-active p-4 text-center border-b-2">Mapa</button>
                <button data-tab="alerts" class="tab p-4 text-center border-b-2 border-transparent">Alertas</button>
                <button data-tab="report" class="tab p-4 text-center border-b-2 border-transparent">Reportar</button>
            </nav>
        </div>

        <!-- MODAL DE DETALHES -->
        <div id="details-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
            <div id="details-modal-content" class="bg-white rounded-lg shadow-xl w-full max-w-md max-h-[90vh] flex flex-col"></div>
        </div>
    </div>

    <!-- TEMPLATES DE CONTEÚDO DAS ABAS -->
    <template id="map-template">
        <div class="relative h-full w-full">
            <div id="map-filters" class="absolute top-3 left-1/2 -translate-x-1/2 z-[1000] bg-white/80 backdrop-blur-sm p-2 rounded-full shadow-lg flex space-x-2">
                <button data-filter="Todos" class="map-filter-btn active-filter px-4 py-1 rounded-full text-sm font-semibold">Todos</button>
                <button data-filter="Cachorro" class="map-filter-btn px-4 py-1 rounded-full text-sm font-semibold">Cães</button>
                <button data-filter="Gato" class="map-filter-btn px-4 py-1 rounded-full text-sm font-semibold">Gatos</button>
            </div>
            <div id="map-container" class="h-full w-full"></div>
        </div>
    </template>
    <template id="alerts-template">
        <div class="p-4">
            <input id="search-bar" type="text" placeholder="Pesquisar por nome..." class="w-full p-3 mb-4 border rounded-lg">
            <div id="alerts-list" class="space-y-3"></div>
        </div>
    </template>
    <template id="report-template">
        <div class="p-4 space-y-4">
            <h2 class="text-lg font-semibold">Reportar Animal Perdido</h2>
            <div><label class="block text-sm font-medium text-gray-700">Nome do Pet</label><input id="report-name" type="text" class="w-full p-2 border rounded-md"></div>
            <div><label class="block text-sm font-medium text-gray-700">Tipo</label><select id="report-type" class="w-full p-2 border rounded-md"><option>Cachorro</option><option>Gato</option><option>Outro</option></select></div>
            <div><label class="block text-sm font-medium text-gray-700">Seu Nome</label><input id="report-contact-name" type="text" class="w-full p-2 border rounded-md"></div>
            <div><label class="block text-sm font-medium text-gray-700">Seu Telefone</label><input id="report-contact-phone" type="tel" class="w-full p-2 border rounded-md"></div>
            <div><label class="block text-sm font-medium text-gray-700">Foto</label><input id="report-photo" type="file" accept="image/*" class="w-full"></div>
            <div><label class="block text-sm font-medium text-gray-700">Última Localização</label><div id="report-map" class="h-48 w-full border rounded-md bg-gray-200 flex items-center justify-center"><p class="text-gray-500">A carregar mapa...</p></div></div>
            <button id="report-submit-btn" class="w-full bg-orange-500 text-white font-bold py-3 rounded-lg hover:bg-orange-600 transition h-14 flex items-center justify-center">Enviar Alerta</button>
        </div>
    </template>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, updateDoc, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        let searchTerm = '', typeFilter = 'Todos';
        const screens = { config: document.getElementById('config-screen'), loading: document.getElementById('loading-screen'), login: document.getElementById('login-screen'), register: document.getElementById('register-screen'), main: document.getElementById('main-app'), };
        let app, auth, db, storage, map, petsCache = [], unsubscribePets, currentUser;

        function showScreen(screenName) { Object.values(screens).forEach(s => s.classList.add('hidden')); if (screens[screenName]) screens[screenName].classList.remove('hidden'); }
        function setButtonLoading(button, isLoading, text = '') { if (isLoading) { button.disabled = true; button.innerHTML = '<div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6 mx-auto"></div>'; } else { button.disabled = false; button.innerHTML = text || button.dataset.originalText; } }

        function initializeAppLogic(config) {
            try {
                app = initializeApp(config); auth = getAuth(app); db = getFirestore(app); storage = getStorage(app);
                showScreen('loading');
                onAuthStateChanged(auth, user => {
                    currentUser = user;
                    if (user) { showScreen('main'); setupApp(user); } else { showScreen('login'); }
                });
                return true;
            } catch (error) {
                document.getElementById('config-error').textContent = 'Configuração do Firebase inválida.'; console.error(error);
                localStorage.removeItem('firebaseConfig'); showScreen('config'); return false;
            }
        }

        function setupApp(user) {
            const mainContent = document.getElementById('main-content');
            const tabs = document.querySelectorAll('.tab');
            function switchTab(tabName) {
                tabs.forEach(t => t.classList.remove('tab-active'));
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('tab-active');
                mainContent.innerHTML = '';
                const template = document.getElementById(`${tabName}-template`);
                if (template) mainContent.appendChild(template.content.cloneNode(true));
                if (tabName === 'map') renderMap();
                if (tabName === 'alerts') renderAlerts();
                if (tabName === 'report') setupReportForm(user);
            }
            tabs.forEach(tab => tab.addEventListener('click', () => switchTab(tab.dataset.tab)));
            if (unsubscribePets) unsubscribePets();
            const q = query(collection(db, "pets"), orderBy("createdAt", "desc"));
            unsubscribePets = onSnapshot(q, (querySnapshot) => {
                petsCache = [];
                querySnapshot.forEach((doc) => petsCache.push({ id: doc.id, ...doc.data() }));
                const activeTab = document.querySelector('.tab-active')?.dataset.tab;
                if(activeTab) switchTab(activeTab);
            });
            switchTab('map');
        }

        async function deletePet(pet) {
            if (!confirm(`Tem a certeza que quer apagar o alerta para "${pet.name}"? Esta ação é irreversível.`)) return;
            const modal = document.getElementById('details-modal');
            modal.innerHTML = '<div class="p-8"><div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24 mx-auto"></div><p class="text-center mt-4">A apagar...</p></div>';
            try {
                await deleteDoc(doc(db, "pets", pet.id));
                const imageRef = ref(storage, pet.photoUri);
                await deleteObject(imageRef);
                alert('Alerta apagado com sucesso!');
            } catch (error) {
                console.error("Erro ao apagar o pet:", error);
                alert('Ocorreu um erro ao apagar o alerta.');
            } finally {
                modal.classList.add('hidden');
            }
        }

        function showDetailsModal(pet) {
            const modal = document.getElementById('details-modal');
            const content = document.getElementById('details-modal-content');
            const isOwner = currentUser && currentUser.uid === pet.authorId;
            const timeSince = (date) => {
                if (!date?.toDate) return '';
                const seconds = Math.floor((new Date().getTime() - date.toDate().getTime()) / 1000);
                let interval = seconds / 86400; if (interval > 1) return `há ${Math.floor(interval)} dias`;
                interval = seconds / 3600; if (interval > 1) return `há ${Math.floor(interval)} horas`;
                interval = seconds / 60; if (interval > 1) return `há ${Math.floor(interval)} minutos`;
                return 'agora mesmo';
            };
            content.innerHTML = `
                <header class="p-4 border-b flex justify-between items-center"><h2 class="text-xl font-bold">${pet.name}</h2><button id="close-modal-btn" class="text-2xl font-bold">&times;</button></header>
                <div class="p-4 overflow-y-auto">
                    <img src="${pet.photoUri}" class="w-full h-64 object-cover rounded-lg mb-4">
                    <div class="flex items-center justify-between mb-4"><span class="bg-orange-100 text-orange-800 text-sm font-medium mr-2 px-2.5 py-0.5 rounded">${pet.type}</span><span class="text-sm text-gray-500">${timeSince(pet.createdAt)}</span></div>
                    ${pet.isFound ? '<div class="mb-4 p-3 bg-green-100 text-green-800 rounded-lg text-center font-semibold">Este pet já foi encontrado!</div>' : ''}
                    <h3 class="text-lg font-semibold mt-4 mb-2">Informações de Contacto</h3>
                    <p><strong class="font-semibold">Nome:</strong> ${pet.contactName}</p><p><strong class="font-semibold">Telefone:</strong> ${pet.contactPhone}</p>
                    <a href="tel:${pet.contactPhone}" class="mt-4 w-full block text-center bg-green-500 text-white font-bold py-3 rounded-lg hover:bg-green-600 transition">Ligar</a>
                    ${isOwner ? `<h3 class="text-lg font-semibold mt-6 mb-2">Ações do Dono</h3><div class="space-y-2"><button id="toggle-found-btn" class="w-full bg-blue-500 text-white font-bold py-3 rounded-lg hover:bg-blue-600 transition">${pet.isFound ? 'Marcar como Perdido' : 'Marcar como Encontrado'}</button><button id="delete-btn" class="w-full bg-red-600 text-white font-bold py-3 rounded-lg hover:bg-red-700 transition">Apagar Alerta</button></div>` : ''}
                </div>`;
            modal.classList.remove('hidden');
            document.getElementById('close-modal-btn').onclick = () => modal.classList.add('hidden');
            if(isOwner) {
                document.getElementById('toggle-found-btn').onclick = async () => {
                    const petDocRef = doc(db, 'pets', pet.id);
                    await updateDoc(petDocRef, { isFound: !pet.isFound });
                    modal.classList.add('hidden');
                };
                document.getElementById('delete-btn').onclick = () => deletePet(pet);
            }
        }

        function renderMap() {
            if (map) map.remove();
            navigator.geolocation.getCurrentPosition(position => {
                const { latitude, longitude } = position.coords;
                map = L.map('map-container').setView([latitude, longitude], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                const filteredPets = petsCache.filter(pet => typeFilter === 'Todos' || pet.type === pet.type);
                filteredPets.forEach(pet => {
                    const icon = L.divIcon({ html: `<img src="${pet.photoUri}" style="width: 40px; height: 40px; border-radius: 50%; border: 3px solid ${pet.isFound ? '#28a745' : '#f4511e'}; box-shadow: 0 0 5px rgba(0,0,0,0.5);">`, className: '', iconSize: [40, 40] });
                    const marker = L.marker([pet.location.latitude, pet.location.longitude], { icon }).addTo(map);
                    marker.on('click', () => showDetailsModal(pet));
                });
            }, () => { map = L.map('map-container').setView([-16.72, -43.86], 13); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map); });
            document.querySelectorAll('.map-filter-btn').forEach(btn => {
                if (btn.dataset.filter === typeFilter) btn.classList.add('active-filter');
                btn.onclick = () => { typeFilter = btn.dataset.filter; renderMap(); };
            });
        }

        function renderAlerts() {
            const list = document.getElementById('alerts-list');
            const searchBar = document.getElementById('search-bar');
            searchBar.value = searchTerm;
            const filteredPets = petsCache.filter(pet => pet.name.toLowerCase().includes(searchTerm.toLowerCase()));
            list.innerHTML = '';
            if (filteredPets.length === 0) { list.innerHTML = '<p class="text-center text-gray-500 mt-8">Nenhum alerta encontrado.</p>'; return; }
            filteredPets.forEach(pet => {
                const card = document.createElement('div');
                card.className = `p-4 bg-white rounded-lg shadow flex items-center space-x-4 cursor-pointer ${pet.isFound ? 'opacity-50' : ''}`;
                card.innerHTML = `<img src="${pet.photoUri}" class="w-20 h-20 rounded-md object-cover"><div class="flex-grow"><div><h3 class="font-bold text-lg">${pet.name}</h3><p class="text-gray-600">${pet.type}</p></div>${pet.isFound ? '<span class="mt-2 text-xs bg-green-100 text-green-800 p-1 rounded-md font-semibold">Encontrado</span>' : ''}</div>`;
                card.onclick = () => showDetailsModal(pet);
                list.appendChild(card);
            });
            searchBar.oninput = (e) => { searchTerm = e.target.value; renderAlerts(); };
        }
        
        function setupReportForm(user) {
            const reportMapContainer = document.getElementById('report-map');
            let reportMap, marker, currentCoords = { lat: -16.722, lng: -43.869 };
            const initializeMap = (lat, lng) => {
                if (reportMap) reportMap.remove();
                reportMapContainer.innerHTML = '';
                reportMap = L.map(reportMapContainer).setView([lat, lng], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(reportMap);
                marker = L.marker([lat, lng], { draggable: true }).addTo(reportMap);
                currentCoords = marker.getLatLng();
                marker.on('dragend', (e) => { currentCoords = e.target.getLatLng(); });
            };
            navigator.geolocation.getCurrentPosition(pos => initializeMap(pos.coords.latitude, pos.coords.longitude), () => initializeMap(currentCoords.lat, currentCoords.lng));
            const submitBtn = document.getElementById('report-submit-btn');
            submitBtn.dataset.originalText = submitBtn.innerHTML;
            if (!submitBtn.hasAttribute('data-listener-added')) {
                submitBtn.addEventListener('click', async () => {
                    if (!marker) { alert("Mapa não foi inicializado. Por favor, aguarde."); return; }
                    const name = document.getElementById('report-name').value, type = document.getElementById('report-type').value, contactName = document.getElementById('report-contact-name').value, contactPhone = document.getElementById('report-contact-phone').value, photoFile = document.getElementById('report-photo').files[0];
                    if (!name || !photoFile || !contactName || !contactPhone) { alert('Por favor, preencha todos os campos.'); return; }
                    setButtonLoading(submitBtn, true);
                    try {
                        const storageRef = ref(storage, `pets/${Date.now()}_${photoFile.name}`);
                        await uploadBytes(storageRef, photoFile);
                        const photoUri = await getDownloadURL(storageRef);
                        await addDoc(collection(db, "pets"), { name, type, contactName, contactPhone, photoUri, location: { latitude: currentCoords.lat, longitude: currentCoords.lng }, isFound: false, authorId: user.uid, createdAt: serverTimestamp() });
                        alert('Alerta enviado com sucesso!');
                        document.querySelector('[data-tab="alerts"]').click();
                    } catch (e) {
                        let errorMessage = 'Erro ao enviar o alerta. Tente novamente.';
                        if (e.code === 'storage/unauthorized') { errorMessage = 'Erro de Permissão: Verifique as regras do Firebase Storage.'; }
                        alert(errorMessage); console.error("Erro completo:", e);
                    } finally { setButtonLoading(submitBtn, false); }
                });
                submitBtn.setAttribute('data-listener-added', 'true');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const loginBtn = document.getElementById('login-btn'), registerBtn = document.getElementById('register-btn');
            loginBtn.dataset.originalText = 'Entrar'; registerBtn.dataset.originalText = 'Registar';
            loginBtn.innerHTML = 'Entrar'; registerBtn.innerHTML = 'Registar';
            
            loginBtn.addEventListener('click', async () => {
                const email = document.getElementById('login-email').value, password = document.getElementById('login-password').value;
                setButtonLoading(loginBtn, true);
                try { await signInWithEmailAndPassword(auth, email, password); } catch (error) { alert(error.message);
                } finally { setButtonLoading(loginBtn, false); }
            });
            registerBtn.addEventListener('click', async () => {
                const email = document.getElementById('register-email').value, password = document.getElementById('register-password').value;
                setButtonLoading(registerBtn, true);
                try { await createUserWithEmailAndPassword(auth, email, password); alert('Conta criada! Por favor, faça login.'); showScreen('login');
                } catch (error) { alert(error.message);
                } finally { setButtonLoading(registerBtn, false); }
            });
            document.getElementById('save-config-btn').addEventListener('click', () => {
                const configText = document.getElementById('firebase-config-input').value;
                document.getElementById('config-error').textContent = '';
                try {
                    const config = (new Function(`return ${configText.trim() || '{}'}`))();
                    if (typeof config !== 'object' || config === null || !config.apiKey) throw new Error("Configuração inválida");
                    localStorage.setItem('firebaseConfig', JSON.stringify(config));
                    initializeAppLogic(config);
                } catch (e) { document.getElementById('config-error').textContent = 'Formato de configuração inválido.'; }
            });
            const savedConfig = localStorage.getItem('firebaseConfig');
            if (savedConfig) { initializeAppLogic(JSON.parse(savedConfig)); } else { showScreen('config'); }
            document.getElementById('goto-register-btn').addEventListener('click', () => showScreen('register'));
            document.getElementById('goto-login-btn').addEventListener('click', () => showScreen('login'));
            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
        });
    </script>
</body>
</html>
